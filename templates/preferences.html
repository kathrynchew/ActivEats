{% extends 'base.html' %}
{% block title %}Preferences{% endblock %}
{% block content %}
<br>
<h1>{{ session['username'] }}'s Profile</h1>
<hr>

<div class="col-sm-4">
<ul class="list-group" id="pref-stuff">
  <li class="list-group-item active"><b>DIETARY PREFERENCES:</b> <button id="editPrefs" type="button" class="btn btn-light btn-sm float-right">Edit</button></li>

    {% if user_info.preferences|length > 0 %}
        {% for pref in user_info.preferences %}
            <li class="list-group-item">{{ pref.category.category_name }}</li>
        {% endfor %}
    {% else %}
      <li class="list-group-item">You have not specified any dietary preferences.</li>
    {% endif %}
</ul>
</div>
<hr>
<h3>Login Information:</h3>
    <b>username:</b> {{ user_info.username }}<br>
    <b>email address:</b> {{ user_info.email }}
<hr>
<h3>Meal Plan History:</h3>


<div class="accordion" id="accordionExample">

  {% for week in past_plans.items()|sort(reverse = True) %}

  <div class="card">
    <div class="card-header bg-primary text-light" id="heading{{ week[0] }}" data-toggle="collapse" data-target="#collapse{{ week[0] }}" aria-expanded="true" aria-controls="collapse{{ week[0] }}">
      <h5 class="mb-0">
        <button class="btn btn-link text-light" type="button" data-toggle="collapse" data-target="#collapse{{ week[0] }}" aria-expanded="true" aria-controls="collapse{{ week[0] }}">
          <b>Week of {{ week[1][0].assigned_date.strftime('%b %-d, %Y') }}</b>
        </button>
      </h5>
    </div>

    <div id="collapse{{ week[0] }}" class="collapse" aria-labelledby="heading{{ week[0] }}" data-parent="#accordionExample">
      <div class="card-body">
       <!-- {{ past_plans[week] }} -->

       <table class="table table-sm">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Monday</th>
                  <th scope="col">Tuesday</th>
                  <th scope="col">Wednesday</th>
                  <th scope="col">Thursday</th>
                  <th scope="col">Friday</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">Breakfast</th>
                  {% for meal in week[1] %}
                  {% if meal.meal_type == 'breakfast' %}
                  <td><a href='/recipes/{{ meal.recipe_id }}'>{{ meal.recipe.recipe_name }}</a></td>
                  {% endif %}
                  {% endfor %}
                </tr>
                <tr>
                  <th scope="row">Lunch</th>
                  {% for meal in week[1] %}
                  {% if meal.meal_type == 'lunch' %}
                  <td><a href='/recipes/{{ meal.recipe_id }}'>{{ meal.recipe.recipe_name }}</a></td>
                  {% endif %}
                  {% endfor %}
                </tr>
                <tr>
                  <th scope="row">Dinner</th>
                  {% for meal in week[1] %}
                  {% if meal.meal_type == 'dinner' %}
                  <td><a href='/recipes/{{ meal.recipe_id }}'>{{ meal.recipe.recipe_name }}</a></td>
                  {% endif %}
                  {% endfor %}
                </tr>

              </tbody>
          </table>
      </div>
    </div>
  </div>

  {% endfor %}

</div>

<script type="text/javascript">
let $jq = jQuery.noConflict();

// for (var i=0; i<whatever; ++i) {
//     d[i];
// }

console.log({{ past_plans }});

function editPreferences(evt) {

    document.querySelector("#pref-stuff").innerHTML = '<form id="update_pref_form" action="/preferences/edit" method="POST"><div class="form-group form-check" id="user-preferences" aria-describedby="preferenceHelp"><li class="list-group-item"><input type="checkbox" class="form-check-input" id="pref-vegetarian" name="prefs" value="Vegetarian"><label class="form-check-label" for="exampleCheck1">Vegetarian</label></li><li class="list-group-item"><input type="checkbox" class="form-check-input" id="pref-vegan" name="prefs" value="Vegan"><label class="form-check-label" for="exampleCheck1">Vegan</label></li><li class="list-group-item"><input type="checkbox" class="form-check-input" id="pref-glutenfree" name="prefs" value="Gluten Free"><label class="form-check-label" for="exampleCheck1">Gluten Free</label></li><li class="list-group-item"><input type="checkbox" class="form-check-input" id="pref-lowcarb" name="prefs" value="Low-Carb"><label class="form-check-label" for="exampleCheck1">Low-Carb</label></li><li class="list-group-item"><input type="checkbox" class="form-check-input" id="pref-lowcal" name="prefs" value="Low Calorie"><label class="form-check-label" for="exampleCheck1">Low Calorie</label></li></div><input type="submit" id="setPrefs"></form>';

    document.querySelector("#setPrefs").addEventListener('click', submitPreferences)
}

function submitPreferences(evt) {
    evt.preventDefault();

    let prefs = []
    $("input:checkbox[name=prefs]:checked").each(function(){
        prefs.push($(this).val());
    });

    $jq.post("/preferences/edit", {'prefs': prefs}, displayPreferences);
}


function displayPreferences(results) {
    let new_prefs = results;

    document.querySelector("#pref-stuff").innerHTML = new_prefs;
    document.querySelector("#edit-prefs").addEventListener('click', editPreferences);
}

document.querySelector("#editPrefs").addEventListener('click', editPreferences);

</script>
{% endblock %}